<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بوابة الطالب</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for mobile app feel */
        body {
            @apply bg-gray-100 font-sans text-right text-gray-800;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        /* Phone Screen Wrapper */
        .phone-wrapper {
            @apply relative mx-auto h-[calc(100dvh)] max-h-[100dvh] w-full max-w-lg overflow-hidden rounded-3xl bg-white shadow-2xl transition-all duration-300 ease-in-out;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Scrollable Content */
        .scrollable-content {
            @apply h-[calc(100%-8rem)] overflow-y-auto px-4 py-4;
            -webkit-overflow-scrolling: touch;
        }

        /* Custom Scrollbar for a sleek look */
        .scrollable-content::-webkit-scrollbar {
            width: 4px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background-color: #3b82f6;
            border-radius: 2px;
        }

        /* Smooth transitions */
        .page-transition {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        /* Form animations */
        .form-group-animated {
            animation: fadeInUp 0.4s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bottom navigation active state */
        .nav-item.active {
            @apply text-blue-600;
            position: relative;
        }
        
        .nav-item.active::after {
            content: '';
            @apply absolute bottom-0 w-6 h-1 bg-blue-600 rounded-full;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Status badges */
        .status-badge {
            @apply px-2 py-1 rounded-full text-xs font-medium;
        }
        
        .status-paid {
            @apply bg-green-100 text-green-800;
        }
        
        .status-pending {
            @apply bg-yellow-100 text-yellow-800;
        }
        
        .status-late {
            @apply bg-red-100 text-red-800;
        }

        /* Attendance dot indicator */
        .attendance-dot {
            @apply w-3 h-3 rounded-full;
        }
        
        .present {
            @apply bg-green-500;
        }
        
        .absent {
            @apply bg-red-500;
        }
        
        .late {
            @apply bg-yellow-500;
        }

        /* Loading spinner */
        .loading-spinner {
            @apply w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin;
        }

        /* Card hover effect */
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Input focus effect */
        .input-focus:focus {
            @apply ring-2 ring-blue-300 border-blue-500;
            outline: none;
        }

        /* Button press effect */
        .btn-press:active {
            transform: scale(0.98);
        }
    </style>
    <!-- Load Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Load Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.min.js"></script>
    <!-- Load Axios for HTTP requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-200 flex items-center justify-center p-4 min-h-screen">
    <!-- Main application wrapper mimicking a phone screen -->
    <div id="app" class="phone-wrapper">
        <!-- Login Page -->
        <div id="login-page" class="h-full w-full page-transition" :style="{display: currentPage === 'login' ? 'block' : 'none', opacity: currentPage === 'login' ? 1 : 0}">
            <div class="flex h-full w-full flex-col items-center justify-center bg-gradient-to-b from-blue-600 to-blue-700 p-8 text-white">
                <div class="mb-8 rounded-full bg-white p-4 text-blue-600 shadow-xl transform transition-all duration-300 hover:scale-105">
                    <i class="fas fa-graduation-cap text-4xl"></i>
                </div>
                <h1 class="mb-8 text-3xl font-bold text-center">بوابة الطالب</h1>
                <div id="login-form-container" class="w-full max-w-sm rounded-xl bg-white p-6 shadow-2xl transform transition-all duration-300 hover:shadow-lg">
                    <h2 class="mb-6 text-center text-2xl font-semibold text-gray-800">تسجيل الدخول</h2>
                    <div id="login-alert" class="mb-4 rounded-lg bg-red-100 p-3 text-sm text-red-700" :class="{'hidden': !loginError}" role="alert">
                        {{ loginError }}
                    </div>
                    <form id="login-form" class="space-y-4" @submit.prevent="handleLogin">
                        <div class="form-group-animated">
                            <label for="username" class="mb-2 block text-sm font-medium text-gray-700">اسم المستخدم</label>
                            <input type="text" id="username" v-model="loginForm.username" 
                                   class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                   required placeholder="أدخل اسم المستخدم">
                        </div>
                        <div class="form-group-animated" style="animation-delay: 0.1s">
                            <label for="password" class="mb-2 block text-sm font-medium text-gray-700">كلمة المرور</label>
                            <input type="password" id="password" v-model="loginForm.password" 
                                   class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                   required placeholder="أدخل كلمة المرور">
                        </div>
                        <button type="submit" id="login-btn" 
                                class="w-full rounded-lg bg-blue-500 py-3 font-semibold text-white transition-all hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 btn-press flex justify-center items-center"
                                :disabled="isLoggingIn">
                            <span v-if="!isLoggingIn">تسجيل الدخول</span>
                            <span v-else class="loading-spinner"></span>
                        </button>
                    </form>
                    <div class="mt-4 text-center text-sm">
                        <a href="#" id="register-link" class="text-blue-500 hover:text-blue-600 transition-colors" @click.prevent="switchToPage('register')">
                            ليس لديك حساب؟ سجل الآن
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Registration Page -->
        <div id="register-page" class="h-full w-full page-transition" :style="{display: currentPage === 'register' ? 'block' : 'none', opacity: currentPage === 'register' ? 1 : 0}">
            <div class="h-full w-full bg-gray-50 p-6">
                <div class="flex items-center mb-6">
                    <button @click="switchToPage('login')" class="text-blue-500 p-2 rounded-full hover:bg-blue-50 transition-colors">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <h1 class="text-center text-2xl font-bold text-gray-800 flex-1">تسجيل طالب جديد</h1>
                </div>
                
                <div id="register-alert" class="mb-4 rounded-lg bg-red-100 p-3 text-sm text-red-700" :class="{'hidden': !registrationError}" role="alert">
                    {{ registrationError }}
                </div>
                <div id="register-success-alert" class="mb-4 rounded-lg bg-green-100 p-3 text-sm text-green-700" :class="{'hidden': !registrationSuccess}" role="alert">
                    {{ registrationSuccess }}
                </div>
                
                <div class="scrollable-content !p-0">
                    <form id="register-form" class="space-y-5" @submit.prevent="handleRegistration">
                        <!-- Basic Information Section -->
                        <div class="rounded-xl bg-white p-6 shadow-lg card-hover">
                            <h3 class="mb-4 border-b pb-2 text-lg font-semibold text-blue-600 flex items-center">
                                <i class="fas fa-user-circle mr-2"></i>
                                المعلومات الأساسية
                            </h3>
                            <div class="space-y-4">
                                <div class="form-group-animated" style="animation-delay: 0.1s">
                                    <label for="reg-name" class="mb-1 block text-sm font-medium text-gray-700">الاسم الكامل</label>
                                    <input type="text" id="reg-name" v-model="registrationForm.name" 
                                           class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                           required placeholder="الاسم الكامل للطالب">
                                </div>
                                
                                <div class="form-group-animated" style="animation-delay: 0.2s">
                                    <label for="reg-year" class="mb-1 block text-sm font-medium text-gray-700">السنة الدراسية</label>
                                    <select id="reg-year" v-model="registrationForm.academicYear" 
                                            class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                            required>
                                        <option value="">اختر سنة دراسية</option>
                                        <option value="1AS">الأولى ثانوي</option>
                                        <option value="2AS">الثانية ثانوي</option>
                                        <option value="3AS">الثالثة ثانوي</option>
                                        <option value="4MS">الرابعة متوسط</option>
                                        <option value="5MS">الخامسة متوسط</option>
                                        <option value="1AP">الأولى ابتدائي</option>
                                        <option value="2AP">الثانية ابتدائي</option>
                                        <option value="3AP">الثالثة ابتدائي</option>
                                        <option value="4AP">الرابعة ابتدائي</option>
                                        <option value="5AP">الخامسة ابتدائي</option>
                                        <option value="NS">غير محدد</option>
                                    </select>
                                </div>
                                
                                <div class="form-group-animated" style="animation-delay: 0.3s">
                                    <label for="reg-birthdate" class="mb-1 block text-sm font-medium text-gray-700">تاريخ الميلاد</label>
                                    <input type="date" id="reg-birthdate" v-model="registrationForm.birthDate" 
                                           class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus">
                                </div>
                            </div>
                        </div>

                        <!-- Parent Information Section -->
                        <div class="rounded-xl bg-white p-6 shadow-lg card-hover">
                            <h3 class="mb-4 border-b pb-2 text-lg font-semibold text-blue-600 flex items-center">
                                <i class="fas fa-user-friends mr-2"></i>
                                معلومات ولي الأمر
                            </h3>
                            <div class="space-y-4">
                                <div class="form-group-animated" style="animation-delay: 0.4s">
                                    <label for="reg-parentname" class="mb-1 block text-sm font-medium text-gray-700">اسم ولي الأمر</label>
                                    <input type="text" id="reg-parentname" v-model="registrationForm.parentName" 
                                           class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                           required placeholder="اسم ولي الأمر">
                                </div>
                                
                                <div class="form-group-animated" style="animation-delay: 0.5s">
                                    <label for="reg-parentphone" class="mb-1 block text-sm font-medium text-gray-700">رقم هاتف ولي الأمر</label>
                                    <input type="tel" id="reg-parentphone" v-model="registrationForm.parentPhone" 
                                           class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                           required placeholder="رقم الهاتف">
                                </div>
                                
                                <div class="form-group-animated" style="animation-delay: 0.6s">
                                    <label for="reg-parentemail" class="mb-1 block text-sm font-medium text-gray-700">البريد الإلكتروني لولي الأمر</label>
                                    <input type="email" id="reg-parentemail" v-model="registrationForm.parentEmail" 
                                           class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                           placeholder="البريد الإلكتروني (اختياري)">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Information Section -->
                        <div class="rounded-xl bg-white p-6 shadow-lg card-hover">
                            <h3 class="mb-4 border-b pb-2 text-lg font-semibold text-blue-600 flex items-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                معلومات إضافية
                            </h3>
                            <div class="space-y-4">
                                <div class="form-group-animated" style="animation-delay: 0.7s">
                                    <label for="reg-address" class="mb-1 block text-sm font-medium text-gray-700">العنوان</label>
                                    <input type="text" id="reg-address" v-model="registrationForm.address" 
                                           class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                           placeholder="العنوان (اختياري)">
                                </div>
                                
                                <div class="form-group-animated" style="animation-delay: 0.8s">
                                    <label for="reg-previousschool" class="mb-1 block text-sm font-medium text-gray-700">المدرسة السابقة</label>
                                    <input type="text" id="reg-previousschool" v-model="registrationForm.previousSchool" 
                                           class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                           placeholder="المدرسة السابقة (اختياري)">
                                </div>
                                
                                <div class="form-group-animated" style="animation-delay: 0.9s">
                                    <label for="reg-healthinfo" class="mb-1 block text-sm font-medium text-gray-700">معلومات صحية</label>
                                    <textarea id="reg-healthinfo" v-model="registrationForm.healthInfo" 
                                              class="w-full rounded-lg border border-gray-300 p-3 text-gray-900 focus:border-blue-500 focus:ring-blue-500 input-focus" 
                                              rows="2" placeholder="أي معلومات صحية مهمة (اختياري)"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" id="register-btn" 
                                class="w-full rounded-lg bg-blue-500 py-4 font-semibold text-white transition-all hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 btn-press flex justify-center items-center"
                                :disabled="isRegistering">
                            <span v-if="!isRegistering">تسجيل الطلب</span>
                            <span v-else class="loading-spinner"></span>
                        </button>
                    </form>
                </div>
                
                <div class="mt-4 text-center text-sm">
                    <a href="#" id="login-link" class="text-blue-500 hover:text-blue-600 transition-colors" @click.prevent="switchToPage('login')">
                        لديك حساب بالفعل؟ سجل الدخول
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Dashboard View -->
        <div id="dashboard-page" class="h-full w-full flex flex-col page-transition" :style="{display: currentPage === 'dashboard' ? 'flex' : 'none', opacity: currentPage === 'dashboard' ? 1 : 0}">
            <!-- Top Bar (Header) -->
            <header class="bg-white p-4 shadow-md">
                <div class="flex items-center justify-between">
                    <h1 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-graduation-cap text-blue-500 mr-2"></i>
                        بوابة الطالب
                    </h1>
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <button id="notifications-btn" class="relative text-gray-600 hover:text-blue-500 transition-colors">
                            <i class="fas fa-bell text-xl"></i>
                            <span class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full"></span>
                        </button>
                        <button id="logout-btn" @click="logout" class="rounded-full bg-gray-100 px-4 py-1 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200 flex items-center">
                            <i class="fas fa-sign-out-alt ml-1"></i>
                            تسجيل الخروج
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <div id="content-area" class="flex-1 scrollable-content">
                <!-- Tab: Dashboard Home -->
                <div id="home-tab" class="space-y-6" :style="{display: activeTab === 'home' ? 'block' : 'none'}">
                    <!-- Welcome Card -->
                    <div class="rounded-xl bg-gradient-to-r from-blue-600 to-blue-500 p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-semibold">مرحباً بك، <span id="student-name">{{ studentData.name }}</span>!</h2>
                                <p class="mt-1 text-sm text-blue-100">هنا نظرة عامة على تقدمك الدراسي</p>
                            </div>
                            <div class="relative">
                                <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                    <i class="fas fa-user-circle text-2xl"></i>
                                </div>
                                <span class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-white"></span>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                            <div class="rounded-lg bg-white/10 p-3 backdrop-blur-sm">
                                <span class="text-xl font-bold block" id="student-id">{{ studentData.studentId }}</span>
                                <p class="mt-1 text-xs text-blue-200">رقم الطالب</p>
                            </div>
                            <div class="rounded-lg bg-white/10 p-3 backdrop-blur-sm">
                                <span class="text-xl font-bold block" id="student-year">{{ formatAcademicYear(studentData.academicYear) }}</span>
                                <p class="mt-1 text-xs text-blue-200">السنة الدراسية</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-3 gap-3">
                        <button @click="showTab('classes')" class="rounded-lg bg-white p-4 shadow text-center transition-all hover:bg-blue-50 hover:text-blue-600">
                            <i class="fas fa-calendar-alt text-blue-500 text-xl mb-2"></i>
                            <p class="text-sm font-medium">جدول الحصص</p>
                        </button>
                        <button @click="showTab('payments')" class="rounded-lg bg-white p-4 shadow text-center transition-all hover:bg-blue-50 hover:text-blue-600">
                            <i class="fas fa-credit-card text-green-500 text-xl mb-2"></i>
                            <p class="text-sm font-medium">الدفعات</p>
                        </button>
                        <button @click="showTab('attendance')" class="rounded-lg bg-white p-4 shadow text-center transition-all hover:bg-blue-50 hover:text-blue-600">
                            <i class="fas fa-clipboard-check text-purple-500 text-xl mb-2"></i>
                            <p class="text-sm font-medium">الحضور</p>
                        </button>
                    </div>
                    
                    <!-- Upcoming Classes -->
                    <div class="rounded-xl bg-white p-6 shadow-lg">
                        <div class="mb-4 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-clock text-blue-500 mr-2"></i>
                                الحصص القادمة
                            </h3>
                            <a href="#" class="text-blue-500 transition-colors hover:text-blue-600 text-sm flex items-center" @click.prevent="showTab('classes')">
                                عرض الكل
                                <i class="fas fa-arrow-left ml-1"></i>
                            </a>
                        </div>
                        <div id="upcoming-classes-list" class="space-y-4">
                            <div v-if="upcomingClasses.length === 0" class="text-center py-6">
                                <i class="fas fa-calendar-times text-3xl text-gray-400 mb-2"></i>
                                <p class="text-gray-500">لا توجد حصص قادمة</p>
                            </div>
                            
                            <div v-for="(cls, index) in upcomingClasses.slice(0, 3)" :key="index" 
                                 class="border border-gray-200 rounded-lg p-4 hover:border-blue-200 transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-medium text-gray-800">{{ cls.className }}</h4>
                                        <p class="text-sm text-gray-600">{{ cls.subject }}</p>
                                    </div>
                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">{{ cls.time }}</span>
                                </div>
                                <div class="mt-3 flex items-center text-sm text-gray-500">
                                    <i class="fas fa-user-tie mr-1"></i>
                                    <span>{{ cls.teacher }}</span>
                                </div>
                                <div class="mt-1 flex items-center text-sm text-gray-500">
                                    <i class="fas fa-map-marker-alt mr-1"></i>
                                    <span>{{ cls.classroom }}</span>
                                </div>
                                <div class="mt-2 pt-2 border-t border-gray-100 flex justify-between items-center">
                                    <span class="text-xs text-gray-500">{{ cls.formattedDate }}</span>
                                    <span class="text-xs font-medium" :class="{
                                        'text-green-600': cls.day === days[new Date().getDay()],
                                        'text-blue-600': cls.day !== days[new Date().getDay()]
                                    }">
                                        {{ cls.day }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Payments -->
                    <div class="rounded-xl bg-white p-6 shadow-lg">
                        <div class="mb-4 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-money-bill-wave text-green-500 mr-2"></i>
                                آخر الدفعات
                            </h3>
                            <a href="#" class="text-blue-500 transition-colors hover:text-blue-600 text-sm flex items-center" @click.prevent="showTab('payments')">
                                عرض الكل
                                <i class="fas fa-arrow-left ml-1"></i>
                            </a>
                        </div>
                        <div v-if="payments.length === 0" class="text-center py-6">
                            <i class="fas fa-wallet text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500">لا توجد دفعات مسجلة</p>
                        </div>
                        
                        <div v-for="(payment, index) in payments.slice(0, 2)" :key="index" class="border-b border-gray-100 pb-4 mb-4 last:border-0 last:pb-0 last:mb-0">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium text-gray-800">{{ formatMonth(payment.month) }}</h4>
                                    <p class="text-sm text-gray-600">{{ payment.class.name }}</p>
                                </div>
                                <div>
                                    <span class="block text-lg font-semibold text-right">{{ payment.amount }} د.ك</span>
                                    <span class="status-badge" :class="{
                                        'status-paid': payment.status === 'paid',
                                        'status-pending': payment.status === 'pending',
                                        'status-late': payment.status === 'late'
                                    }">
                                        {{ formatPaymentStatus(payment.status) }}
                                    </span>
                                </div>
                            </div>
                            <div v-if="payment.paymentDate" class="mt-2 text-xs text-gray-500">
                                <i class="fas fa-calendar-check mr-1"></i>
                                تم السداد في {{ formatDate(payment.paymentDate) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Classes -->
                <div id="classes-tab" class="space-y-6" :style="{display: activeTab === 'classes' ? 'block' : 'none'}">
                    <div class="flex items-center justify-between mb-4">
                        <button @click="showTab('home')" class="text-blue-500 p-2 rounded-full hover:bg-blue-50 transition-colors">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <h2 class="text-xl font-semibold text-gray-800 flex-1 text-center">جدول الحصص الأسبوعي</h2>
                    </div>
                    
                    <div class="overflow-x-auto rounded-xl shadow-lg">
                        <table class="w-full min-w-max bg-white text-sm">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600">
                                    <th class="p-3 text-center">اليوم</th>
                                    <th class="p-3 text-center">المادة</th>
                                    <th class="p-3 text-center">الوقت</th>
                                    <th class="p-3 text-center">القاعة</th>
                                </tr>
                            </thead>
                            <tbody id="classes-table-body">
                                <tr v-for="day in days" :key="day">
                                    <td class="p-3 text-center font-medium bg-gray-50" :class="{'text-blue-600': day === days[new Date().getDay()]}">{{ day }}</td>
                                    <td colspan="3" class="p-0">
                                        <div v-if="weeklySchedule[day] && weeklySchedule[day].length > 0">
                                            <div v-for="(cls, index) in weeklySchedule[day]" :key="index" 
                                                 class="border-t border-gray-200 p-3 hover:bg-gray-50 transition-colors">
                                                <div class="grid grid-cols-3 gap-2">
                                                    <div class="text-center">{{ cls.subject }}</div>
                                                    <div class="text-center">{{ cls.time }}</div>
                                                    <div class="text-center">{{ cls.classroom }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-else class="text-center py-3 text-gray-500">
                                            لا توجد حصص
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab: Payments -->
                <div id="payments-tab" class="space-y-6" :style="{display: activeTab === 'payments' ? 'block' : 'none'}">
                    <div class="flex items-center justify-between mb-4">
                        <button @click="showTab('home')" class="text-blue-500 p-2 rounded-full hover:bg-blue-50 transition-colors">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <h2 class="text-xl font-semibold text-gray-800 flex-1 text-center">سجل الدفعات</h2>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-medium text-gray-800">إجمالي الدفعات</h3>
                            <span class="text-lg font-bold text-blue-600">
                                {{ totalPaidAmount }} د.ك
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <h3 class="font-medium text-gray-800">المتبقي</h3>
                            <span class="text-lg font-bold text-red-600">
                                {{ totalPendingAmount }} د.ك
                            </span>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto rounded-xl shadow-lg">
                        <table class="w-full min-w-max bg-white text-sm">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600">
                                    <th class="p-3 text-center">الشهر</th>
                                    <th class="p-3 text-center">المبلغ</th>
                                    <th class="p-3 text-center">الحصة</th>
                                    <th class="p-3 text-center">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="payments-table-body">
                                <tr v-for="(payment, index) in payments" :key="index" class="border-t border-gray-200 hover:bg-gray-50 transition-colors">
                                    <td class="p-3 text-center">{{ formatMonth(payment.month) }}</td>
                                    <td class="p-3 text-center font-medium">{{ payment.amount }} د.ك</td>
                                    <td class="p-3 text-center text-gray-600">{{ payment.class.name }}</td>
                                    <td class="p-3 text-center">
                                        <span class="status-badge" :class="{
                                            'status-paid': payment.status === 'paid',
                                            'status-pending': payment.status === 'pending',
                                            'status-late': payment.status === 'late'
                                        }">
                                            {{ formatPaymentStatus(payment.status) }}
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div v-if="payments.length === 0" class="text-center py-10 bg-white rounded-xl shadow-lg">
                        <i class="fas fa-wallet text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-500">لا توجد دفعات مسجلة</p>
                    </div>
                </div>

                <!-- Tab: Attendance -->
                <div id="attendance-tab" class="space-y-6" :style="{display: activeTab === 'attendance' ? 'block' : 'none'}">
                    <div class="flex items-center justify-between mb-4">
                        <button @click="showTab('home')" class="text-blue-500 p-2 rounded-full hover:bg-blue-50 transition-colors">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <h2 class="text-xl font-semibold text-gray-800 flex-1 text-center">سجل الحضور</h2>
                    </div>
                    
                    <div class="rounded-xl bg-white p-6 shadow-lg">
                        <div class="mb-6">
                            <h3 class="font-medium text-gray-800 mb-2">نسبة الحضور</h3>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="bg-green-500 h-4 rounded-full" :style="{width: attendancePercentage + '%'}"></div>
                            </div>
                            <div class="flex justify-between mt-1 text-xs text-gray-600">
                                <span>{{ attendanceCount.present }} حاضر</span>
                                <span>{{ attendanceCount.total }} إجمالي الحصص</span>
                            </div>
                        </div>
                        
                        <div id="attendance-timeline" class="relative">
                            <div class="border-r-2 border-gray-200 absolute h-full left-1/2 transform -translate-x-1/2"></div>
                            
                            <div v-if="attendanceRecords.length === 0" class="text-center py-10">
                                <i class="fas fa-clipboard-list text-4xl text-gray-400 mb-3"></i>
                                <p class="text-gray-500">لا توجد سجلات حضور</p>
                            </div>
                            
                            <div v-for="(record, index) in attendanceRecords" :key="index" class="mb-6 flex justify-between items-center relative">
                                <div class="w-1/2 pr-6 text-right">
                                    <div class="bg-white p-3 rounded-lg shadow-sm">
                                        <h4 class="font-medium text-gray-800">{{ record.class.name }}</h4>
                                        <p class="text-sm text-gray-600">{{ formatDate(record.date) }}</p>
                                    </div>
                                </div>
                                <div class="w-1/2 pl-6">
                                    <div class="flex items-center">
                                        <div class="attendance-dot flex-shrink-0" :class="{
                                            'present': record.status === 'present',
                                            'absent': record.status === 'absent',
                                            'late': record.status === 'late'
                                        }"></div>
                                        <span class="text-sm font-medium ml-2">{{ formatAttendanceStatus(record.status) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Navigation Bar -->
            <nav id="bottom-nav" class="bg-white p-2 shadow-lg border-t border-gray-100">
                <ul class="flex justify-around items-center h-16">
                    <li>
                        <a href="#" class="nav-item flex flex-col items-center justify-center transition-colors" 
                           :class="{'active text-blue-600': activeTab === 'home', 'text-gray-500 hover:text-blue-500': activeTab !== 'home'}" 
                           @click.prevent="showTab('home')">
                            <i class="fas fa-home text-xl"></i>
                            <span class="text-xs font-semibold mt-1">الرئيسية</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-item flex flex-col items-center justify-center transition-colors" 
                           :class="{'active text-blue-600': activeTab === 'classes', 'text-gray-500 hover:text-blue-500': activeTab !== 'classes'}" 
                           @click.prevent="showTab('classes')">
                            <i class="fas fa-calendar-alt text-xl"></i>
                            <span class="text-xs font-semibold mt-1">الحصص</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-item flex flex-col items-center justify-center transition-colors" 
                           :class="{'active text-blue-600': activeTab === 'payments', 'text-gray-500 hover:text-blue-500': activeTab !== 'payments'}" 
                           @click.prevent="showTab('payments')">
                            <i class="fas fa-credit-card text-xl"></i>
                            <span class="text-xs font-semibold mt-1">الدفعات</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="nav-item flex flex-col items-center justify-center transition-colors" 
                           :class="{'active text-blue-600': activeTab === 'attendance', 'text-gray-500 hover:text-blue-500': activeTab !== 'attendance'}" 
                           @click.prevent="showTab('attendance')">
                            <i class="fas fa-clipboard-check text-xl"></i>
                            <span class="text-xs font-semibold mt-1">الحضور</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // State
                const currentPage = ref('login');
                const activeTab = ref('home');
                const isLoggingIn = ref(false);
                const isRegistering = ref(false);
                const loginError = ref('');
                const registrationError = ref('');
                const registrationSuccess = ref('');
                const token = ref(localStorage.getItem('studentToken') || '');
                
                // Days of week for schedule
                const days = ref(['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت']);
                
                // Student data
                const studentData = ref({
                    name: '',
                    studentId: '',
                    academicYear: '',
                    parentName: '',
                    parentPhone: '',
                    parentEmail: '',
                    birthDate: null
                });
                
                const upcomingClasses = ref([]);
                const weeklySchedule = ref({
                    'الأحد': [],
                    'الإثنين': [],
                    'الثلاثاء': [],
                    'الأربعاء': [],
                    'الخميس': [],
                    'الجمعة': [],
                    'السبت': []
                });
                
                const payments = ref([]);
                const attendanceRecords = ref([]);
                
                // Forms
                const loginForm = ref({
                    username: '',
                    password: ''
                });

                const registrationForm = ref({
                    name: '',
                    academicYear: '1AS',
                    birthDate: '',
                    parentName: '',
                    parentPhone: '',
                    parentEmail: '',
                    address: '',
                    previousSchool: '',
                    healthInfo: ''
                });

                // Computed properties
                const totalPaidAmount = computed(() => {
                    return payments.value
                        .filter(p => p.status === 'paid')
                        .reduce((sum, p) => sum + p.amount, 0)
                        .toFixed(2);
                });
                
                const totalPendingAmount = computed(() => {
                    return payments.value
                        .filter(p => p.status !== 'paid')
                        .reduce((sum, p) => sum + p.amount, 0)
                        .toFixed(2);
                });
                
                const attendanceCount = computed(() => {
                    const count = {
                        present: attendanceRecords.value.filter(a => a.status === 'present').length,
                        absent: attendanceRecords.value.filter(a => a.status === 'absent').length,
                        late: attendanceRecords.value.filter(a => a.status === 'late').length,
                        total: attendanceRecords.value.length
                    };
                    
                    return count;
                });
                
                const attendancePercentage = computed(() => {
                    if (attendanceCount.value.total === 0) return 0;
                    return Math.round((attendanceCount.value.present / attendanceCount.value.total) * 100);
                });

                // Methods
                const switchToPage = (page) => {
                    currentPage.value = page;
                    loginError.value = '';
                    registrationError.value = '';
                    registrationSuccess.value = '';
                };

                const showTab = (tab) => {
                    activeTab.value = tab;
                    // Scroll to top when changing tabs
                    setTimeout(() => {
                        const contentArea = document.querySelector('.scrollable-content');
                        if (contentArea) contentArea.scrollTop = 0;
                    }, 50);
                };

                const handleLogin = async () => {
                    isLoggingIn.value = true;
                    loginError.value = '';
                    
                    try {
                        const response = await axios.post('http://localhost:4200/api/student/login', loginForm.value);
                        token.value = response.data.token;
                        localStorage.setItem('studentToken', token.value);
                        
                        // Fetch student data
                        await fetchStudentData();
                        currentPage.value = 'dashboard';
                    } catch (error) {
                        console.error('Login error:', error);
                        loginError.value = error.response?.data?.error || 'فشل تسجيل الدخول. يرجى المحاولة مرة أخرى.';
                    } finally {
                        isLoggingIn.value = false;
                    }
                };

                const handleRegistration = async () => {
                    isRegistering.value = true;
                    registrationError.value = '';
                    registrationSuccess.value = '';
                    
                    try {
                        const response = await axios.post('http://localhost:4200/api/student/register', registrationForm.value);
                        registrationSuccess.value = 'تم استلام طلب التسجيل بنجاح. سيتم التواصل معك بعد مراجعة البيانات.';
                        
                        // Clear form
                        registrationForm.value = {
                            name: '',
                            academicYear: '1AS',
                            birthDate: '',
                            parentName: '',
                            parentPhone: '',
                            parentEmail: '',
                            address: '',
                            previousSchool: '',
                            healthInfo: ''
                        };
                        
                        // Switch to login after 3 seconds
                        setTimeout(() => {
                            switchToPage('login');
                        }, 3000);
                    } catch (error) {
                        console.error('Registration error:', error);
                        registrationError.value = error.response?.data?.error || 'فشل تسجيل الطلب. يرجى المحاولة مرة أخرى.';
                    } finally {
                        isRegistering.value = false;
                    }
                };

                const logout = () => {
                    token.value = '';
                    localStorage.removeItem('studentToken');
                    currentPage.value = 'login';
                    activeTab.value = 'home';
                };

                const fetchStudentData = async () => {
                    try {
                        const response = await axios.get('http://localhost:4200/api/student/data', {
                            headers: {
                                'Authorization': `Bearer ${token.value}`
                            }
                        });
                        
                        studentData.value = response.data.student;
                        upcomingClasses.value = response.data.upcomingClasses;
                        payments.value = response.data.payments;
                        
                        // Organize weekly schedule
                        weeklySchedule.value = {
                            'الأحد': [],
                            'الإثنين': [],
                            'الثلاثاء': [],
                            'الأربعاء': [],
                            'الخميس': [],
                            'الجمعة': [],
                            'السبت': []
                        };
                        
                        if (response.data.student.classes) {
                            response.data.student.classes.forEach(cls => {
                                if (cls.schedule) {
                                    cls.schedule.forEach(session => {
                                        if (weeklySchedule.value[session.day]) {
                                            weeklySchedule.value[session.day].push({
                                                classId: cls._id,
                                                className: cls.name,
                                                subject: cls.subject,
                                                teacher: cls.teacher?.name || 'غير محدد',
                                                time: session.time,
                                                classroom: session.classroom?.name || 'غير محدد'
                                            });
                                        }
                                    });
                                }
                            });
                        }
                        
                        // Sort classes by time
                        Object.keys(weeklySchedule.value).forEach(day => {
                            weeklySchedule.value[day].sort((a, b) => {
                                const [aHours, aMinutes] = a.time.split(':').map(Number);
                                const [bHours, bMinutes] = b.time.split(':').map(Number);
                                return (aHours * 60 + aMinutes) - (bHours * 60 + bMinutes);
                            });
                        });
                        
                        // Fetch attendance records
                        await fetchAttendanceRecords();
                    } catch (error) {
                        console.error('Error fetching student data:', error);
                        if (error.response?.status === 401) {
                            logout();
                        }
                    }
                };

                const fetchAttendanceRecords = async () => {
                    try {
                        const response = await axios.get('http://localhost:4200/api/attendance', {
                            params: {
                                student: studentData.value._id
                            },
                            headers: {
                                'Authorization': `Bearer ${token.value}`
                            }
                        });
                        attendanceRecords.value = response.data;
                    } catch (error) {
                        console.error('Error fetching attendance records:', error);
                    }
                };

                // Formatting helpers
                const formatDate = (dateString) => {
                    if (!dateString) return '---';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('ar-EG', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                };

                const formatMonth = (monthString) => {
                    if (!monthString) return '---';
                    const [year, month] = monthString.split('-');
                    const date = new Date(year, month - 1, 1);
                    return date.toLocaleDateString('ar-EG', { 
                        month: 'long', 
                        year: 'numeric' 
                    });
                };

                const formatPaymentStatus = (status) => {
                    const statusMap = {
                        'paid': 'مسددة',
                        'pending': 'قيد الانتظار',
                        'late': 'متأخرة'
                    };
                    return statusMap[status] || status;
                };

                const formatAttendanceStatus = (status) => {
                    const statusMap = {
                        'present': 'حاضر',
                        'absent': 'غائب',
                        'late': 'متأخر'
                    };
                    return statusMap[status] || status;
                };

                const formatAcademicYear = (year) => {
                    const yearMap = {
                        '1AS': 'الأولى ثانوي',
                        '2AS': 'الثانية ثانوي',
                        '3AS': 'الثالثة ثانوي',
                        '1MS': 'الأولى متوسط',
                        '2MS': 'الثانية متوسط',
                        '3MS': 'الثالثة متوسط',
                        '4MS': 'الرابعة متوسط',
                        '5MS': 'الخامسة متوسط',
                        '1AP': 'الأولى ابتدائي',
                        '2AP': 'الثانية ابتدائي',
                        '3AP': 'الثالثة ابتدائي',
                        '4AP': 'الرابعة ابتدائي',
                        '5AP': 'الخامسة ابتدائي',
                        'NS': 'غير محدد'
                    };
                    return yearMap[year] || year;
                };

                // Lifecycle hooks
                onMounted(() => {
                    if (token.value) {
                        currentPage.value = 'dashboard';
                        fetchStudentData();
                    }
                });

                return {
                    // State
                    currentPage,
                    activeTab,
                    isLoggingIn,
                    isRegistering,
                    loginError,
                    registrationError,
                    registrationSuccess,
                    studentData,
                    upcomingClasses,
                    weeklySchedule,
                    payments,
                    attendanceRecords,
                    days,
                    
                    // Forms
                    loginForm,
                    registrationForm,
                    
                    // Computed
                    totalPaidAmount,
                    totalPendingAmount,
                    attendanceCount,
                    attendancePercentage,
                    
                    // Methods
                    switchToPage,
                    showTab,
                    handleLogin,
                    handleRegistration,
                    logout,
                    
                    // Formatting helpers
                    formatDate,
                    formatMonth,
                    formatPaymentStatus,
                    formatAttendanceStatus,
                    formatAcademicYear
                };
            }
        }).mount('#app');
    </script>
</body>
</html>